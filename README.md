# SPEC-1-FamilyTreeApp

## Background

Theo truy·ªÅn th·ªëng vƒÉn h√≥a Vi·ªát Nam, vi·ªác duy tr√¨ v√† ph√°t tri·ªÉn Gia ph·∫£ kh√¥ng ch·ªâ mang √Ω nghƒ©a l∆∞u gi·ªØ ngu·ªìn c·ªôi m√† c√≤n l√† m·ªôt ph∆∞∆°ng ti·ªán gi√°o d·ª•c con ch√°u v·ªÅ truy·ªÅn th·ªëng d√≤ng h·ªç. Tuy nhi√™n, h√¨nh th·ª©c ghi ch√©p th·ªß c√¥ng hi·ªán nay ƒëang ƒë·ªëi m·∫∑t v·ªõi nhi·ªÅu h·∫°n ch·∫ø: kh√≥ c·∫≠p nh·∫≠t, d·ªÖ th·∫•t l·∫°c, v√† thi·∫øu t√≠nh tr·ª±c quan khi tra c·ª©u.

·ª®ng d·ª•ng "Qu·∫£n l√Ω Gia ph·∫£ d√≤ng t·ªôc" ƒë∆∞·ª£c thi·∫øt k·∫ø nh·∫±m m·ª•c ti√™u hi·ªán ƒë·∫°i h√≥a qu√° tr√¨nh n√†y b·∫±ng c√°ch s·ªë h√≥a d·ªØ li·ªáu gia ph·∫£, gi√∫p c√°c th√†nh vi√™n trong d√≤ng h·ªç d·ªÖ d√†ng c·∫≠p nh·∫≠t, tra c·ª©u v√† b·∫£o t·ªìn th√¥ng tin th·∫ø h·ªá m·ªôt c√°ch l√¢u d√†i v√† khoa h·ªçc. ·ª®ng d·ª•ng s·∫Ω h·ªó tr·ª£ hi·ªÉn th·ªã c√¢y ph·∫£ h·ªá d·∫°ng s∆° ƒë·ªì, qu·∫£n l√Ω chi ti·∫øt th√¥ng tin t·ª´ng th√†nh vi√™n, l·ªãch s·ª± ki·ªán li√™n quan ƒë·∫øn d√≤ng h·ªç v√† ƒë·ªìng b·ªô h√≥a d·ªØ li·ªáu gi·ªØa nhi·ªÅu th√†nh vi√™n trong h·ªç.

T·ªët! D·ª±a theo m√¥ t·∫£ ch·ª©c nƒÉng b·∫°n ƒë√£ ƒë∆∞a ra, m√¨nh ƒë√£ ph√¢n lo·∫°i c√°c y√™u c·∫ßu theo m√¥ h√¨nh **MoSCoW** (Must have, Should have, Could have, Won‚Äôt have for now). D∆∞·ªõi ƒë√¢y l√† ph·∫ßn **Requirements**:

## Requirements

### ‚úÖ Must Have (B·∫Øt bu·ªôc ph·∫£i c√≥)

* Qu·∫£n l√Ω th√¥ng tin th√†nh vi√™n:

  * H·ªç t√™n, ng√†y sinh, ng√†y m·∫•t
  * Gi·ªõi t√≠nh, ngh·ªÅ nghi·ªáp
  * ·∫¢nh ƒë·∫°i di·ªán
  * Ti·ªÉu s·ª≠, n∆°i sinh, n∆°i c∆∞ tr√∫
  * Vai tr√≤ trong d√≤ng t·ªôc (tr∆∞·ªüng h·ªç, ng∆∞·ªùi th·ªù c√∫ng,‚Ä¶)
* Qu·∫£n l√Ω m·ªëi quan h·ªá:

  * Cha ‚Äì m·∫π ‚Äì con, v·ª£/ch·ªìng
  * Hi·ªÉn th·ªã c√¢y gia ph·∫£ d·∫°ng s∆° ƒë·ªì
* T√¨m ki·∫øm v√† l·ªçc th√¥ng tin:

  * Theo t√™n, nƒÉm sinh, gi·ªõi t√≠nh, d√≤ng chi
* L∆∞u tr·ªØ d·ªØ li·ªáu:

  * D·ªØ li·ªáu c·ª•c b·ªô ho·∫∑c tr√™n cloud
  * ƒê·ªìng b·ªô gi·ªØa c√°c th√†nh vi√™n (qua ph√¢n quy·ªÅn)
* H·ªó tr·ª£ ƒëa n·ªÅn t·∫£ng (Web l√† ch√≠nh, mobile h·ªó tr·ª£ c∆° b·∫£n)
* Giao di·ªán ƒë∆°n gi·∫£n, th√¢n thi·ªán v·ªõi ng∆∞·ªùi l·ªõn tu·ªïi
* Ch·∫ø ƒë·ªô xem offline (c√≥ b·ªô ƒë·ªám d·ªØ li·ªáu)

### ‚úÖ Should Have (N√™n c√≥)

* T√≠nh nƒÉng t√¨m quan h·ªá: "√îng A l√† g√¨ c·ªßa t√¥i?"
* L∆∞u tr·ªØ v√† xu·∫•t b·∫£n:

  * Xu·∫•t ra PDF/·∫£nh ƒë·ªÉ in
* Qu·∫£n l√Ω s·ª± ki·ªán:

  * Sinh nh·∫≠t, ng√†y gi·ªó, l·ªãch nh·∫Øc
  * G·ª≠i th√¥ng b√°o qua email/app
* Ph√¢n quy·ªÅn ng∆∞·ªùi d√πng:

  * Ng∆∞·ªùi xem, ng∆∞·ªùi ch·ªânh s·ª≠a, qu·∫£n tr·ªã vi√™n

### ‚úÖ Could Have (C√≥ th·ªÉ c√≥ sau n√†y)

* Ghi √¢m l·ªùi k·ªÉ c·ªßa ng∆∞·ªùi l·ªõn tu·ªïi
* H·ªá th·ªëng ch·ªânh s·ª≠a c√≥ nh·∫≠t k√Ω (audit log)
* L∆∞u tr·ªØ t√†i li·ªáu d√≤ng h·ªç (vƒÉn t·∫ø, di ch√∫c‚Ä¶)
* T√≠ch h·ª£p b·∫£n ƒë·ªì hi·ªÉn th·ªã n∆°i s·ªëng/sinh/t·ª≠
* In kh·ªï l·ªõn c√≥ th·ªÉ cu·ªôn

### ‚ùå Won‚Äôt Have (Ch∆∞a l√†m ·ªü phi√™n b·∫£n ƒë·∫ßu)

* T√≠ch h·ª£p AI t√¨m quan h·ªá t·ª± ƒë·ªông
* Nh·∫≠n d·∫°ng ·∫£nh ch√¢n dung

## Method 

1. T·ªïng quan ki·∫øn tr√∫c
2. Thi·∫øt k·∫ø c∆° s·ªü d·ªØ li·ªáu
3. Thu·∫≠t to√°n suy di·ªÖn m·ªëi quan h·ªá
4. Th√†nh ph·∫ßn giao di·ªán v√† backend

---

### üéØ B∆∞·ªõc 1: Ki·∫øn tr√∫c t·ªïng quan (version MVP)

M√¨nh ƒë·ªÅ xu·∫•t s·ª≠ d·ª•ng ki·∫øn tr√∫c **Web + Cloud-based** ƒë∆°n gi·∫£n, d·ªÖ tri·ªÉn khai, d·ªÖ m·ªü r·ªông:

```plaintext
Client (Web) --> API Gateway --> App Server (Node.js/Python) --> Database (PostgreSQL) + Storage (S3)
                                                  |
                                                  --> Auth Server (Firebase Auth / Supabase)
```

#### üîß C√¥ng ngh·ªá ƒë·ªÅ xu·∫•t:

| Th√†nh ph·∫ßn     | C√¥ng ngh·ªá                                           |
| -------------- | --------------------------------------------------- |
| Frontend       | React + Tailwind CSS                                |
| Backend API    | Node.js + Express (ho·∫∑c NestJS)                     |
| Database       | PostgreSQL (quan h·ªá + JSON)                         |
| File Storage   | AWS S3 ho·∫∑c Supabase Storage                        |
| Auth           | Firebase Auth ho·∫∑c Supabase Auth                    |
| Tree Rendering | `d3.js` (d·∫°ng tree layout) ho·∫∑c `react-family-tree` |

---

### ‚úÖ PlantUML s∆° ƒë·ªì t·ªïng quan ki·∫øn tr√∫c (Deployment View)

```plantuml
@startuml
actor User
User -> WebApp : S·ª≠ d·ª•ng
WebApp -> API : G·ª≠i y√™u c·∫ßu
API -> AuthService : X√°c th·ª±c
API -> PostgreSQL : L∆∞u th√¥ng tin
API -> FileStorage : L∆∞u ·∫£nh, file
WebApp -> TreeRenderer : V·∫Ω c√¢y ph·∫£ h·ªá

database PostgreSQL
database FileStorage
component API
component AuthService
component WebApp
component TreeRenderer

@enduml
```

---

## üéØ B∆∞·ªõc 2: Thi·∫øt k·∫ø c∆° s·ªü d·ªØ li·ªáu

### üîë C√°c b·∫£ng ch√≠nh:

```plaintext
1. persons         -- Th√¥ng tin t·ª´ng th√†nh vi√™n
2. relationships   -- Li√™n k·∫øt huy·∫øt th·ªëng v√† h√¥n nh√¢n
3. events          -- C√°c s·ª± ki·ªán (sinh nh·∫≠t, gi·ªó...)
4. users           -- T√†i kho·∫£n ng∆∞·ªùi d√πng
5. permissions     -- Ph√¢n quy·ªÅn ch·ªânh s·ª≠a/xem
6. files           -- ·∫¢nh v√† t√†i li·ªáu li√™n quan
```

---

### ‚úÖ S∆° ƒë·ªì CSDL ƒë∆°n gi·∫£n (ERD)

```plantuml
@startuml
entity "persons" as P {
  id: UUID <<PK>>
  full_name: string
  gender: enum (M/F)
  birth_date: date
  death_date: date?
  bio: text?
  avatar_url: string?
  birth_place: string?
  residence: string?
  role_in_family: string?
  created_at
  updated_at
}

entity "relationships" as R {
  id: UUID <<PK>>
  person_id: UUID <<FK>>
  related_person_id: UUID <<FK>>
  type: enum(parent|spouse|child)
}

entity "events" as E {
  id: UUID <<PK>>
  person_id: UUID <<FK>>
  type: enum(birthday|deathday|anniversary)
  event_date: date
  description: text?
}

entity "users" as U {
  id: UUID <<PK>>
  email: string
  password_hash: string
  display_name: string
  role: enum(viewer|editor|admin)
}

entity "permissions" as PM {
  id: UUID <<PK>>
  user_id: UUID <<FK>>
  person_id: UUID <<FK>>
  can_edit: boolean
}

P -- R : 1-to-many
P -- E : 1-to-many
U -- PM : 1-to-many
P -- PM : 1-to-many
@enduml
```

---

### üìå L∆∞u √Ω ƒë·∫∑c bi·ªát:

* `relationships` l√† b·∫£ng quan h·ªá **2 chi·ªÅu**:

  * V√≠ d·ª•: A l√† **cha** c·ªßa B ‚Üí A ‚Üí B (type: parent)
  * B l√† **con** c·ªßa A ‚Üí B ‚Üí A (type: child)
  * Ta c√≥ th·ªÉ l∆∞u **c·∫£ 2 d√≤ng quan h·ªá** n·∫øu c·∫ßn truy v·∫•n nhanh h∆°n.

---

## üéØ B∆∞·ªõc 3: Thi·∫øt k·∫ø thu·∫≠t to√°n suy di·ªÖn m·ªëi quan h·ªá

### ‚úÖ M·ª•c ti√™u:

T√¨m ƒë∆∞·ªùng ƒëi t·ª´ m·ªôt ng∆∞·ªùi ƒë·∫øn ng∆∞·ªùi kh√°c trong c√¢y ph·∫£ h·ªá qua quan h·ªá `parent`, `child`, `spouse`, sau ƒë√≥ **d·ªãch ƒë∆∞·ªùng ƒëi ƒë√≥ th√†nh quan h·ªá** (v√≠ d·ª•: cha ‚Üí cha ‚Üí con = √¥ng n·ªôi).

---

### üìå √ù t∆∞·ªüng gi·∫£i thu·∫≠t:

1. **Bi·ªÉu di·ªÖn c√¢y gia ph·∫£ nh∆∞ ƒë·ªì th·ªã ƒë·ªãnh h∆∞·ªõng**:

   * ƒê·ªânh: `persons`
   * C·∫°nh: `relationships` (c√≥ nh√£n: parent, child, spouse)

2. **Duy·ªát theo BFS/DFS** t·ª´ ng∆∞·ªùi ngu·ªìn (user), t√¨m ƒë∆∞·ªùng ƒë·∫øn ng∆∞·ªùi ƒë√≠ch.

3. **D·ªãch ƒë∆∞·ªùng ƒëi (path)** th√†nh quan h·ªá ng√¥n ng·ªØ.

---

### ‚úÖ Pseudocode thu·∫≠t to√°n BFS:

```python
def find_relationship_path(graph, source_id, target_id):
    queue = [(source_id, [])]
    visited = set()

    while queue:
        current, path = queue.pop(0)
        if current == target_id:
            return path
        
        visited.add(current)
        for neighbor, relation in graph.get(current, []):
            if neighbor not in visited:
                queue.append((neighbor, path + [relation]))
    
    return None
```

---

### üß† D·ªãch quan h·ªá (rule engine):

V·ªõi m·ªói chu·ªói quan h·ªá, ta d√πng rule mapping:

| Chu·ªói quan h·ªá            | K·∫øt lu·∫≠n         |
| ------------------------ | ---------------- |
| parent ‚Üí parent          | √¥ng/b√† n·ªôi/ngo·∫°i |
| parent ‚Üí sibling ‚Üí child | anh/ch·ªã em h·ªç    |
| child ‚Üí child            | ch√°u             |
| spouse                   | v·ª£/ch·ªìng         |
| parent ‚Üí spouse          | m·∫π k·∫ø/cha d∆∞·ª£ng  |

C√≥ th·ªÉ s·ª≠ d·ª•ng **tree grammar** ho·∫∑c **rule tree** n·∫øu ph·ª©c t·∫°p h∆°n.

---

### ‚úÖ V√≠ d·ª• minh h·ªça:

```plaintext
T√¥i (ID: 1)
-> parent (ID: 2)
-> parent (ID: 3)
==> 3 l√† √¥ng n·ªôi c·ªßa t√¥i
```

---

## üéØ B∆∞·ªõc 4: Frontend & Backend Components

### ‚úÖ 1. Frontend Components (React-based)

| Component            | M√¥ t·∫£ ch·ª©c nƒÉng                                                 |
| -------------------- | --------------------------------------------------------------- |
| `FamilyTreeView`     | Hi·ªÉn th·ªã c√¢y ph·∫£ h·ªá b·∫±ng s∆° ƒë·ªì (d3.js ho·∫∑c `react-family-tree`) |
| `PersonProfile`      | Trang chi ti·∫øt 1 th√†nh vi√™n                                     |
| `PersonForm`         | Th√™m/s·ª≠a th√¥ng tin th√†nh vi√™n                                   |
| `SearchBar`          | T√¨m ki·∫øm theo t√™n, nƒÉm sinh,...                                 |
| `RelationshipFinder` | Giao di·ªán truy v·∫•n "Ng∆∞·ªùi A l√† g√¨ c·ªßa t√¥i?"                     |
| `EventCalendar`      | Hi·ªÉn th·ªã l·ªãch s·ª± ki·ªán d√≤ng h·ªç                                   |
| `FileUpload`         | Giao di·ªán t·∫£i ·∫£nh, t√†i li·ªáu                                     |
| `Login/Register`     | ƒêƒÉng nh·∫≠p, ƒëƒÉng k√Ω t√†i kho·∫£n                                    |
| `AdminPanel`         | Qu·∫£n l√Ω quy·ªÅn, nh·∫≠t k√Ω ch·ªânh s·ª≠a                                |

---

### ‚úÖ 2. Backend API Endpoints (REST ho·∫∑c GraphQL)

| Endpoint                 | Ph∆∞∆°ng th·ª©c         | Ch·ª©c nƒÉng                        |
| ------------------------ | ------------------- | -------------------------------- |
| `/api/persons`           | GET/POST/PUT/DELETE | Qu·∫£n l√Ω th√†nh vi√™n               |
| `/api/relationships`     | POST/DELETE         | T·∫°o quan h·ªá cha ‚Äì con ‚Äì v·ª£ ch·ªìng |
| `/api/search`            | GET                 | T√¨m ki·∫øm th√†nh vi√™n              |
| `/api/relationship-path` | GET                 | Truy xu·∫•t quan h·ªá gi·ªØa hai ng∆∞·ªùi |
| `/api/events`            | GET/POST            | T·∫°o v√† l·∫•y s·ª± ki·ªán               |
| `/api/files/upload`      | POST                | T·∫£i ·∫£nh, file                    |
| `/api/auth`              | POST                | X√°c th·ª±c t√†i kho·∫£n               |
| `/api/permissions`       | GET/POST            | Ph√¢n quy·ªÅn theo ng∆∞·ªùi d√πng       |
| `/api/export`            | GET                 | Xu·∫•t c√¢y gia ph·∫£ ra PDF/·∫¢nh      |

---

### ‚úÖ Deployment Suggestion (dev/staging/prod)

* **Local dev**: Docker Compose (PostgreSQL + Node + React)
* **Staging/Production**:

  * Frontend: Vercel / Netlify
  * Backend: Render / Railway / Supabase Edge Functions
  * DB: Supabase PostgreSQL
  * File Storage: Supabase / S3-compatible

---
